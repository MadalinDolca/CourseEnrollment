<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:insert="head.html" th:with="titlu='Cursuri disponibile'"></head>

<body>
<nav th:insert="/cursant/componente/nav.html"></nav>

<div class="container">
    <h2>Cursurile disponibile</h2>
    <table class="table table-striped">
        <thead>
        <tr>
            <th>ID</th>
            <th>Nume curs</th>
            <th>Actiune</th>
        </tr>
        </thead>
        <tbody id="listaCursuri">
        </tbody>
    </table>
</div>

<script>
    var dateCursant
    var email = sessionStorage.email
    var rol = sessionStorage.rol
    var jwt = sessionStorage.jwt

    // obtine datele cursantului
    $(document).ready(() => {
        $.ajax({
            url: 'http://localhost:8080/cursant/date/' + email,
            method: 'get',
            headers: {'Authorization': jwt},
            success: data => {
                sessionStorage.setItem('dateCursant', JSON.stringify(data))
                dateCursant = JSON.parse(sessionStorage.dateCursant)
                getCursuri() // obtine cursurile
            },
            error: () => afisareMesaj($('.alert-danger'), 'Nu am putut prelua datele cursantului')
        })
    })

    // obtine lista cursurilor din sistem
    function getCursuri() {
        $.ajax({
            url: 'http://localhost:8080/cursant/cursuri',
            method: 'get',
            headers: {'Authorization': jwt},
            success: data => {
                $.each(data, (key, curs) => { // itereaza fiecare entitate din setul de rezultate
                    $("#listaCursuri").append(
                        `<tr>
                            <td>${curs.id}</td>
                            <td>${curs.numeCurs}</td>
                            <td><button type="button" class="btn btn-success" onclick="window.inscriereCurs(${dateCursant.id}, '${curs.numeCurs}', ${curs.id})">Inscrie-te</button></td>
                         </tr>`
                    )
                })
            },
            error: () => window.afisareMesaj($('.alert-danger'), 'Nu am putut obtine cursurile')
        })
    }

    // inscrie cursantul curent la cursul selectat
    function inscriereCurs(cursantId, cursNume, cursId) {
        $.ajax({
            url: `http://localhost:8080/cursant/join?cursantid=${cursantId}&cursid=${cursId}`,
            method: 'patch',
            headers: {'Authorization': jwt},
            success: () => {
                window.afisareMesaj($('.alert-success'), 'Te-ai inscris la: ' + cursNume)
            },
            error: raspuns => {
                window.afisareMesaj($('.alert-danger'), raspuns.responseText)
            }
        })
    }
</script>
</body>
</html>